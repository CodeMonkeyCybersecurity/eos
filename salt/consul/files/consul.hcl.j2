# Consul configuration generated by Salt
# This file is managed by Salt - manual changes will be overwritten

datacenter = "{{ datacenter }}"
data_dir = "/opt/consul/data"
log_level = "INFO"
log_file = "/var/log/consul/"
node_name = "{{ grains.get('id', 'consul-node') }}"
server = {{ 'true' if server_mode else 'false' }}

{% if server_mode %}
bootstrap_expect = {{ pillar.get('consul:bootstrap_expect', 1) }}
{% endif %}

# UI Configuration
ui_config {
  enabled = {{ 'true' if ui_enabled else 'false' }}
}

# Network Configuration
bind_addr = "{{ grains.get('ip4_interfaces:eth0:0', '0.0.0.0') }}"
client_addr = "0.0.0.0"

# Port Configuration
ports {
  http = {{ http_port }}
  https = -1      # Disabled
  grpc = 8502
  dns = {{ dns_port }}
  serf_lan = 8301
  serf_wan = 8302
  server = 8300
}

# Connect Configuration (Service Mesh)
connect {
  enabled = true
}

{% if encrypt_key %}
# Gossip Encryption
encrypt = "{{ encrypt_key }}"
{% endif %}

{% if tls_enabled %}
# TLS Configuration
tls {
  defaults {
    verify_incoming = true
    verify_outgoing = true
    ca_file = "/etc/consul.d/consul-ca.pem"
    cert_file = "/etc/consul.d/consul-cert.pem"
    key_file = "/etc/consul.d/consul-key.pem"
  }
  
  internal_rpc {
    verify_server_hostname = true
  }
}
{% endif %}

# Performance tuning
performance {
  raft_multiplier = 1
}

# Telemetry
telemetry {
  prometheus_retention_time = "60s"
  disable_hostname = true
}

# Enable script checks (carefully)
enable_local_script_checks = true

# Limits
limits {
  http_max_conns_per_client = 200
  rpc_max_conns_per_client = 100
}