services:
  vault:
    image: hashicorp/vault:1.19.1
    container_name: vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: http://0.0.0.0:8200
    ports:
      - "127.0.0.1:8200:8200"  # only accessible locally or through nginx
    volumes:
      - vault-data:/vault/data
      - ./config:/vault/config
      - ./vault-agent:/etc/vault-agent
    command: vault server -config=/vault/config/vault.hcl

  vault-agent:
    image: hashicorp/vault:1.19.1
    container_name: vault-agent
    restart: unless-stopped
    depends_on:
      - vault
    volumes:
      - ./vault-agent:/etc/vault-agent
      - vault-agent-sink:/run/vault
    command: >
      vault agent -config=/etc/vault-agent/agent.hcl

  nginx:
    image: nginx:alpine
    container_name: vault-nginx
    restart: unless-stopped
    ports:
      - "8201:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - vault

volumes:
  vault-data:
  vault-agent-sink:
