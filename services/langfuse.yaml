name: langfuse
version: "2.0.0"
metadata:
  description: Declarative initialization flow for Langfuse observability stack.
  owners:
    - platform-engineering
dependencies:
  containers:
    - langfuse
    - langfuse-db
  commands:
    - curl
    - jq
    - docker
healthcheck:
  type: http
  url: http://localhost:3000/api/public/health
  timeout: 60s
  retries: 30
  interval: 2s
initialization:
  steps:
    - name: wait_for_service
      type: healthcheck
      retries:
        max_attempts: 30
        initial_delay: 2s
        max_delay: 10s
    - name: create_user
      type: api_call
      requires:
        - wait_for_service
      idempotent_check:
        type: database_query
        query: SELECT COUNT(*) FROM users WHERE email='${ADMIN_EMAIL}'
        container: langfuse-db
        user: langfuse
        database: langfuse
      api:
        method: POST
        url: ${LANGFUSE_URL}/api/auth/signup
        headers:
          Content-Type: application/json
        body_template: |
          {
            "email": "${ADMIN_EMAIL}",
            "password": "${ADMIN_PASSWORD}",
            "name": "${ADMIN_NAME}"
          }
        success_codes: [200, 201]
        idempotent_codes: [409, 422]
    - name: login
      type: api_call
      requires:
        - create_user
      api:
        method: GET
        url: ${LANGFUSE_URL}/api/auth/csrf
        extract:
          csrf_token: .csrfToken
      then:
        method: POST
        url: ${LANGFUSE_URL}/api/auth/signin/credentials
        headers:
          Content-Type: application/x-www-form-urlencoded
        body_template: |
          email=${ADMIN_EMAIL}&password=${ADMIN_PASSWORD}&csrfToken=${csrf_token}&json=true
        extract_cookie: next-auth.session-token
    - name: create_project
      type: api_call
      requires:
        - login
      api:
        method: POST
        url: ${LANGFUSE_URL}/api/public/projects
        headers:
          Cookie: next-auth.session-token=${session_cookie}
          X-CSRF-Token: ${csrf_token}
        body_template: |
          {
            "name": "${PROJECT_NAME}"
          }
        extract:
          project_id: .id
    - name: generate_keys
      type: api_call
      requires:
        - create_project
      api:
        method: POST
        url: ${LANGFUSE_URL}/api/public/api-keys
        headers:
          Cookie: next-auth.session-token=${session_cookie}
          X-CSRF-Token: ${csrf_token}
        body_template: |
          {
            "projectId": "${project_id}",
            "note": "Generated by EOS CLI"
          }
        extract:
          public_key: .publicKey
          secret_key: .secretKey
    - name: store_credentials
      type: vault_write
      requires:
        - generate_keys
      path: secret/langfuse/api-keys
      data:
        public_key: ${public_key}
        secret_key: ${secret_key}
        project_id: ${project_id}
        admin_email: ${ADMIN_EMAIL}
    - name: update_env
      type: env_update
      requires:
        - store_credentials
      file: /opt/bionicgpt/.env
      variables:
        LANGFUSE_PUBLIC_KEY: ${public_key}
        LANGFUSE_SECRET_KEY: ${secret_key}
        LANGFUSE_HOST: http://langfuse-server:3000
    - name: restart_litellm
      type: docker_restart
      requires:
        - update_env
      containers:
        - bionicgpt-litellm
variables:
  required:
    - ADMIN_EMAIL
    - ADMIN_PASSWORD
  optional:
    ADMIN_NAME: Admin
    PROJECT_NAME: Moni
    LANGFUSE_URL: http://localhost:3000
